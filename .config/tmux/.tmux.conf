# 1-based window numbering
set -g base-index 1
setw -g pane-base-index 1

# Automatically renumber windows when one is closed
set -g renumber-windows on

# Ensure new windows and panes start with proper index
set-hook -g after-new-window 'move-window'
set-hook -g after-kill-pane 'move-window'

# Custom window naming logic
# Show process name, but replace 'node' with 'claude' when appropriate
# Include Claude status indicator and context
# set-window-option -g automatic-rename on
set-window-option -g automatic-rename-format '#{?#{==:#{pane_current_command},node},#{b:pane_current_path},#{pane_current_command}}'

# Alternative status indicators for Claude sessions:
# ▁ (U+2581) - Lower 1/4 block - New session
# ▄ (U+2584) - Lower 1/2 block - Claude working
# █ (U+2588) - Full block - Claude output complete
# ▀ (U+2580) - Upper 1/2 block - Other state

# Set window status format to show custom title with active window indicator
set -g window-status-format '#I:#W'
set -g window-status-current-format '#[reverse]#I:#W#[noreverse]'

# Move status bar to top and style it
set -g status-position top
set -g status-style bg=green,fg=black
set -g window-status-current-style bg=black,fg=green,bold

# Allow pane titles to be set
# set -g pane-border-status top
# set -g pane-border-format '#{pane_title}'

# Enable mouse support
set -g mouse on

# Copy mode configuration for clipboard integration
set -g mode-keys vi
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"

# Enable automatic copy-on-select with mouse
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection-and-cancel

# Better scrolling behavior for TUI applications
# This allows applications to handle mouse events when needed
set -g @scroll-speed-num-lines-per-scroll 3

# Allow terminal scrolling with mouse wheel when in copy mode
bind -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'copy-mode -e; send-keys -M'"

# Alternative mouse behavior that works better with some TUI apps
# Uncomment these lines if the above doesn't work well with Claude
# set -g terminal-overrides 'xterm*:smcup@:rmcup@'
# set -g alternate-screen on

# Increase scrollback buffer size
set -g history-limit 50000

# Enable focus events (useful for some TUI applications)
set-option -g focus-events on

# Better terminal support
set -g default-terminal "tmux-256color"
set-option -sa terminal-overrides ",xterm*:Tc"
set -ga terminal-overrides ",*256col*:Tc:RGB"
set -ga terminal-overrides ",xterm*:Tc:RGB:Ms=\\E]52;c;%p2%s\\7"
set -ga terminal-overrides ",screen*:Tc:RGB"
set -ga terminal-overrides ",tmux*:Tc:RGB"

# Enable OSC 8 hyperlink support for clickable URLs
set -ga terminal-overrides ",*:Hls=\\E]8;id=%p1%s;%p2%s\\E\\\\:Hlr=\\E]8;;\\E\\\\"

# UTF-8 support
set -q -g status-utf8 on
setw -q -g utf8 on

# Force UTF-8 environment
set-environment -g LANG en_US.UTF-8
set-environment -g LC_ALL en_US.UTF-8

# Conditional session name display 
# Show session name only if it's not the hostname or if multiple sessions exist
set -g status-left "#{?#{!=:#{session_name},#{host_short}},[#{session_name}] ,}"

# Network status and pane title on status right
# Check if connected via ethernet (en5) or wifi (en0)
set -g status-right "#{pane_title} | #(if ifconfig en5 | grep -q 'status: active'; then echo '●'; elif ifconfig en0 | grep -q 'status: active'; then echo '◉'; else echo '◯'; fi)"

# kill pane
bind-key x kill-pane

# Split panes with current path
bind '[' split-window -v -c "#{pane_current_path}"
bind ']' split-window -h -c "#{pane_current_path}"
# Preserve current working directory when creating new panes
bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

# Pane resizing
bind -n M-h resize-pane -L
bind -n M-l resize-pane -R
bind -n M-k resize-pane -U
bind -n M-j resize-pane -D

# Move window to the left
bind -n M-i swap-window -t -1

# Move window to the right
bind -n M-o swap-window -t +1

# URL handling - open URLs with Ctrl+B u
bind u run-shell 'tmux capture-pane -p | grep -oE "https?://[^[:space:]]+" | tail -1 | xargs open'

# Save and restore session
set -g @resurrect-save 'S'
set -g @resurrect-restore 'R'

# Tmux theme
set -g @catppuccin_flavour 'mocha'
set -g @catppuccin_right_separator "█"
set -g @catppuccin_left_separator "█"

TMUX_FZF_ORDER="session|window|pane|command|keybinding"
TMUX_FZF_OPTIONS="-p -w 90% -h 70% -m"

# more options here: https://github.com/sainnhe/tmux-fzf/issues/6#issuecomment-578750879
bind w run-shell -b "~/.config/tmux/plugins/tmux-fzf/scripts/window.sh switch"

# Claude notification system - Ghostty compatible
# Hook to detect when Claude is awaiting response using OSC 777 escape sequence
set-hook -g pane-title-changed 'if -F "#{&&:#{==:#{pane_current_command},node},#{m/r:.*claude.*,#{pane_title}}}" "run-shell \"printf \\\"\\033]777;notify;Claude Code;Claude is awaiting your response\\007\\\"; printf \\\"\\a\\\"\""'

# Plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'oca159/catppuccin-tmux'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @resurrect-strategy-nvim 'session'

run '~/.config/tmux/plugins/tpm/tpm'
